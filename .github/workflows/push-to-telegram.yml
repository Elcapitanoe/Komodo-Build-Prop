name: Push To Telegram

on:
  workflow_dispatch:

jobs:
  send-release-assets:
    runs-on: ubuntu-latest

    steps:
      - name: Get Latest Release Info
        id: release
        uses: actions/github-script@v7
        with:
          script: |
            const release = await github.rest.repos.getLatestRelease({
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            const assets = release.data.assets;
            const tag = release.data.tag_name;
            const name = release.data.name || tag;
            const date = new Date(release.data.published_at).toISOString().split('T')[0];
            const body = release.data.body || "_No changelog_";

            if (assets.length === 0) {
              core.setFailed("âš ï¸ No assets found in the latest release!");
              return;
            }

            // Dummy SHA-256 placeholder
            const sha256 = "aee6d58b5ff97194deff58d8c704d640443bc54c32e18252904963626aec6232";

            core.setOutput("assets", JSON.stringify(assets.map(a => a.browser_download_url)));
            core.setOutput("tag", tag);
            core.setOutput("name", name);
            core.setOutput("date", date);
            core.setOutput("sha256", sha256);

      - name: Download Release Assets
        run: |
          mkdir assets
          urls=$(echo '${{ steps.release.outputs.assets }}' | jq -r '.[]')
          for url in $urls; do
            filename=$(basename "$url")
            curl -L "$url" -o "assets/$filename"
          done

      - name: Send Telegram Header Message
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          TEXT=$(cat <<EOF
ðŸ”¥ *New Update Released!*

*${{ steps.release.outputs.date }}* \(`${{ steps.release.outputs.tag }}`\)

SHA-256: ${{ steps.release.outputs.sha256 }}
EOF
          )

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="$TEXT" \
            -d parse_mode="Markdown"

      - name: Send Release Files to Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          for file in assets/*; do
            echo "Mengirim $file ke Telegram..."
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendDocument" \
              -F chat_id="$TELEGRAM_CHAT_ID" \
              -F document=@"$file" \
              -F caption="ðŸ“¦ $(basename "$file")"
          done
